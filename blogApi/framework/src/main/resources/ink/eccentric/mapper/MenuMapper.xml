<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="ink.eccentric.mapper.MenuMapper">

    <select id="getRootMenus" resultType="ink.eccentric.domain.vo.menu.RoutesVo">
        <if test="rolesId.contains(1L)">
            select * from sys_menu
            where parent_id=0
              and del_flag=0
              and status=0
              and menu_type in ('M','C')
            order by parent_id,order_num
        </if>
        <if test="!rolesId.contains(1L) and rolesId.size()>0">
            select distinct sm.* from sys_role_menu srm
            left join sys_menu sm on srm.menu_id = sm.id
            where srm.role_id in
            <foreach item="item" index="index" collection="rolesId" open="("
                     separator="," close=")">
                  #{item}
            </foreach>
            and sm.id is not null
            and sm.del_flag=0
            and sm.status=0
            and sm.parent_id=0
            and sm.menu_type in ('M','C')
            order by sm.parent_id,sm.order_num
        </if>
    </select>

    <select id="getChildren" resultType="ink.eccentric.domain.vo.menu.RoutesVo">
        <if test="rolesId.contains(1L)">
            select * from sys_menu
            where parent_id=#{parentId}
              and del_flag=0
              and status=0
              and menu_type in ('M','C')
            order by parent_id,order_num
        </if>
        <if test="!rolesId.contains(1L)">
            select distinct sm.* from sys_role_menu srm
            left join sys_menu sm on srm.menu_id = sm.id
            where srm.role_id in
            <foreach item="item" index="index" collection="rolesId" open="("
                     separator="," close=")">
                #{item}
            </foreach>
            and sm.id is not null
            and sm.del_flag=0
            and sm.status=0
            and sm.parent_id=#{parentId}
            and sm.menu_type in ('M','C')
            order by sm.parent_id,sm.order_num
        </if>
    </select>


    <select id="getAllRootMenus" resultType="ink.eccentric.domain.vo.menu.MenuTreeSelectVo">
        select id,menu_name as label,parent_id from sys_menu
            where del_flag=0 and status=0 and parent_id=0
        order by parent_id,order_num
    </select>
    <select id="getTreeSelectListChildren" resultType="ink.eccentric.domain.vo.menu.MenuTreeSelectVo">
        select id,menu_name as label,parent_id from sys_menu
            where del_flag=0 and status=0 and parent_id=#{parentId}
        order by parent_id,order_num
    </select>

    <select id="list" resultType="ink.eccentric.domain.vo.menu.MenuVo">
        select * from sys_menu where del_flag=0
            <if test="status!=null and status!=''">
                and status like "%"#{status}"%"
            </if>
            <if test="menuName!=null and menuName!=''">
                and menu_name like "%"#{menuName}"%"
            </if>
            order by parent_id,order_num
    </select>

    <insert id="addMenu">
        <if test="menuType=='M'.toString()">
            insert into sys_menu(menu_name,parent_id,order_num,path,menu_type,visible,status,icon,create_by,create_time,update_by,update_time)
                values(#{menuName},#{parentId},#{orderNum},#{path},#{menuType},#{visible},#{status},#{icon},#{createBy},#{createTime},#{updateBy},#{updateTime})
        </if>
        <if test="menuType=='C'.toString()">
            insert into sys_menu(menu_name,parent_id,order_num,path,component,menu_type,visible,status,perms,icon,create_by,create_time,update_by,update_time)
                values(#{menuName},#{parentId},#{orderNum},#{path},#{component},#{menuType},#{visible},#{status},#{perms},#{icon},#{createBy},#{createTime},#{updateBy},#{updateTime})
        </if>
        <if test="menuType=='F'.toString()">
            insert into sys_menu(menu_name,parent_id,order_num,menu_type,visible,status,perms,create_by,create_time,update_by,update_time)
                values(#{menuName},#{parentId},#{orderNum},#{menuType},#{visible},#{status},#{perms},#{createBy},#{createTime},#{updateBy},#{updateTime})
        </if>
    </insert>

    <select id="getChildMenuCount" resultType="java.lang.Integer">
        select count(*) from sys_menu where parent_id=#{parentId}
    </select>

    <update id="deleteMenu">
        update sys_menu set del_flag=1,update_by=#{updateBy},update_time=#{updateTime}
            where id=#{id}
    </update>

    <select id="getMenuById" resultType="ink.eccentric.domain.vo.menu.MenuVo">
        select * from sys_menu where del_flag=0 and id=#{id}
    </select>

    <update id="updateMenu">
        update sys_menu set menu_name=#{menuName},parent_id=#{parentId},order_num=#{orderNum},path=#{path},menu_type=#{menuType},visible=#{visible},status=#{status},update_by=#{updateBy},update_time=#{updateTime}
            <if test="component!=null">
                ,component=#{component}
            </if>
            <if test="perms!=null">
                ,perms=#{perms}
            </if>
            <if test="icon!=null">
                ,icon=#{icon}
            </if>
        where id = #{id}
    </update>
</mapper>
